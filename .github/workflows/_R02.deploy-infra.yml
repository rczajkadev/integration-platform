name: Reusable (R02) - Deploy Bicep Infrastructure

on:
  workflow_call:
    outputs:
      app-name:
        value: ${{ jobs.deploy-infrastructure.outputs.app-name }}
    secrets:
      azure-credentials:
        required: true
      azure-resource-group:
        required: true

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    outputs:
      app-name: ${{ steps.deploy.outputs.app-name }}
    steps:
      - name: Download infrastructure artifact
        uses: actions/download-artifact@v7
        with:
          name: infra
          path: infra

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.azure-credentials }}

      - name: Deploy infrastructure
        id: deploy
        run: |
          deploymentOutput=$(az deployment group create \
            --resource-group ${{ secrets.azure-resource-group }} \
            --template-file infra/main.json \
            --parameters infra/parameters.json \
            --query properties.outputs \
            --output json)

          appName=$(echo $deploymentOutput | jq -r '.appName.value')
          echo "app-name=$appName" >> $GITHUB_OUTPUT
